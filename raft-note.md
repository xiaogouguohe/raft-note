# raft-extended笔记

## 0 摘要

- raft是一种共识算法
  - 和Paxos功能相同，但是算法结构和Paxos不同，这使得Raft算法更容易理解和实现
- Raft将共识算法分解成了几个关键模块，例如
  - 领导人选举
  - 日志复制
  - 安全性
- Raft通过实施一个更强的共识，来减少需要考虑的状态的数量
- Raft还包括一个新的机制，来允许鸡群成员的动态改变，利用重叠的大多数来保证安全性

## 1 介绍

- 共识算法是什么
  - 一组机器像一个整体一样工作
- Paxos占据统治地位，但是依旧很复杂，因此引入Raft
- Raft通过一些手段来增强它的可理解性，包括
  - 算法分解，分成领导人选举，日志复制和安全性三个模块
  - 减少状态机的状态
- Raft算法和现有的共识算法非常相似，但是也有一些独特的特性
  - 强领导者
    - 日志条目只从领导者发送给其它的服务器
    - 这种做法简化了对付之日止的管理
  - 领导选举
    - 通过一个随机计时器来选举领导者
    - 这只是在任何一种共识算法都要实现的心跳机制上增加了点随机性
    - 方便解决冲突
  - 成员关系调整
    - 使用一种共同意志的方式来处理集群成员变换的问题
- 本文介绍的内容
  - 第2章介绍复制状态机
  - 第3节讨论Paxos的优缺点
  - 第4节讨论为了可理解性而采取的方法
  - 第5~8节阐述Raft共识算法
  - 第9节评价Raft算法
  - 第10节涉及一些相关的工作

## 2 复制状态机

- 什么是状态机：保存一些状态信息的结构，例如
  - 数据（图1中体现为键值对）
  - 当前角色（leader，candidate或follower）
- 共识算法是在复制状态机的背景下提出的
  - 一组服务器上的每个状态机保持相同状态（互为副本），并且在一些机器宕掉的状态也可以继续运行
- 复制状态机是基于复制日志实现的
  - 每个服务器存出一个包含一系列指令的日志，并且按照日志的顺序进行执行
  - 每份日志都按照相同的顺序包含相同的指令，因此每个服务器都执行相同的指令序列
  - 每个状态机都是确定的，因此每次执行操作都产生相同的状态和序列
- 保证所有日志的副本相同，是共识算法的工作
  - 在一台服务器上，共识模块接收客户端的指令，然后增加到自己的日志里
  - 它和其他服务器上的共识模块进行通信，来保证每个服务器的日志都完全相同，哪怕有些服务器会宕机
  - 一旦指令被正确复制，每个服务器的状态机会按照日志顺序执行它们，然后把输出结果返回给客户端
- 共识算法的特性
  - 安全性保证
  - 可用性：集群中只要有大多数机器可运行并且能够互相通信、和客户端通信，就可以保证可用
  - 不依赖时序来保证共识：服务器之间时钟的不一致，延迟这些因素，一般不会导致可用性问题
  - 少部分比较慢的节点不会影响系统整体的性能

## 3 Paxos算法的问题

- 不透明
- 没有很好的工业界实现

## 4 为了可理解性的设计

- 使用了两种通常适用的技术来解决这个问题
  - 问题分解
    - Raft被分成领导人选举，日志复制，安全性和角色改变等几个部分
  - 减少状态的数量，来简化需要考虑的状态空间

## 5 Raft一致性算法

- Raft是一种管理复制日志（第2章）的算法
  - 图2总结了这个算法的简略版本
  - 图3列举了这个算法的一些关键特性
- Raft通过选举出一个领导人，然后给予它全部的管理复制日志的责任来实现共识，这些职责包括
  - 从客户端接收日志条目
  - 把日志条目复制到其他服务器上
  - 当保证安全性的时候，告诉其它的服务器，把日志条目用到它们的状态机上
- 领导人可能宕机，或者和其它服务器失去连接，这种情况下会选举出一个新的领导人
- 通过领导人的方式，Raft将共识性问题分解成三个相对独立的子问题
  - 领导选举
    - 当现存的领导人宕机时，要选取新的领导人（5.2）
  - 日志复制
    - 领导人必须从客户端接收日志条目，然后复制到集群中的其它节点，并且强制要求其它节点的日志和自己的保持相同
  - 安全性
    - 如果有任何的服务器已经应用了一个日志条目到它的状态机中，那么其他服务器不能在同一个索引位置应用不同的日志
    - 5.4会阐述Raft如何保证这个特性
    - 这个解决方案涉及到一个额外的选举机制（5.2）
- 展示一致性算法后，这一章会讨论可用性的一些问题，和计时在系统的作用

- 图2的解释

  - ###

- 图3的解释，Raft在任何时候都需要保证的特性

  - 选举安全：在一个任期内，最多只能选出一个领导者（5.2）
  - 领导者在自己的日志上只会追加，不会重写或者删除日志条目（5.3）
  - 日职匹配：如果两份日志包含了一条索引和任期都相同的日志条目，那么这条条目前面的日志条目也都是匹配的（5.3）
  - 领导者完备性：如果一条日志条目在某个任期内被提交了，那么这条条目会出现在所有比当前人气大的领导者的日志里（5.4）

  - 状态机安全性：如果一个服务器应用了某条日志条目，那么在这个索引位置上，不会有其它服务器应用了其它的一条日志条目（5.4.3）

### 5.1 Raft基础

